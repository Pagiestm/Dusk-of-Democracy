/**
 * A compute-based GPU radix sort implementation using 4-bit radix (16 buckets).
 * Provides stable sorting of 32-bit unsigned integer keys, returning sorted indices.
 * WebGPU only.
 *
 * **Performance characteristics:**
 * - 4 passes for 16-bit keys, 8 passes for 32-bit keys
 * - Each pass processes 4 bits (16 buckets)
 * - Workgroup size: 16x16 = 256 threads
 *
 * **Algorithm (per pass):**
 * 1. **Block Sum**: Each thread extracts its 4-bit digit, computes local prefix sum
 *    (count of same-digit elements with lower thread ID), and contributes to
 *    per-workgroup histogram using shared memory atomics.
 * 2. **Prefix Sum**: Hierarchical Blelloch scan on block histograms to compute
 *    global offsets for each (digit, workgroup) pair.
 * 3. **Reorder**: Scatter elements to final positions using:
 *    `position = global_prefix[digit][workgroup] + local_prefix`
 *
 * Based on "Fast 4-way parallel radix sorting on GPUs" algorithm, implemented
 * following [WebGPU-Radix-Sort](https://github.com/kishimisu/WebGPU-Radix-Sort)
 * by kishimisu (MIT License).
 *
 * @example
 * // Create the radix sort instance (reusable)
 * const radixSort = new ComputeRadixSort(device);
 *
 * // Create a storage buffer with keys to sort
 * const keys = new Uint32Array([5, 2, 8, 1, 9, 3]);
 * const keysBuffer = new StorageBuffer(device, keys.byteLength, BUFFERUSAGE_COPY_DST);
 * keysBuffer.write(keys);
 *
 * // Sort and get indices buffer (keys with values [5,2,8,1,9,3] â†’ indices [3,1,5,0,2,4])
 * const sortedIndices = radixSort.sort(keysBuffer, keys.length, 16); // 16-bit sort
 *
 * // Use sortedIndices buffer in subsequent GPU operations
 * // Clean up when done
 * radixSort.destroy();
 *
 * @category Graphics
 * @ignore
 */
export class ComputeRadixSort {
    /**
     * Creates a new ComputeRadixSort instance.
     *
     * @param {GraphicsDevice} device - The graphics device (must support compute).
     */
    constructor(device: GraphicsDevice);
    /**
     * The graphics device.
     *
     * @type {GraphicsDevice}
     */
    device: GraphicsDevice;
    /**
     * Current element count.
     *
     * @type {number}
     */
    _elementCount: number;
    /**
     * Number of workgroups for current sort.
     *
     * @type {number}
     */
    _workgroupCount: number;
    /**
     * Allocated workgroup capacity (only grows, never shrinks).
     *
     * @type {number}
     */
    _allocatedWorkgroupCount: number;
    /**
     * Current number of bits for which passes are created.
     *
     * @type {number}
     */
    _numBits: number;
    /**
     * Internal keys buffer 0 (ping-pong).
     *
     * @type {StorageBuffer|null}
     */
    _keys0: StorageBuffer | null;
    /**
     * Internal keys buffer 1 (ping-pong).
     *
     * @type {StorageBuffer|null}
     */
    _keys1: StorageBuffer | null;
    /**
     * Internal values/indices buffer 0 (ping-pong).
     *
     * @type {StorageBuffer|null}
     */
    _values0: StorageBuffer | null;
    /**
     * Internal values/indices buffer 1 (ping-pong).
     *
     * @type {StorageBuffer|null}
     */
    _values1: StorageBuffer | null;
    /**
     * Local prefix sums buffer (one per element).
     *
     * @type {StorageBuffer|null}
     */
    _localPrefixSums: StorageBuffer | null;
    /**
     * Block sums buffer (16 per workgroup).
     *
     * @type {StorageBuffer|null}
     */
    _blockSums: StorageBuffer | null;
    /**
     * Output sorted indices buffer.
     *
     * @type {StorageBuffer|null}
     */
    _sortedIndices: StorageBuffer | null;
    /**
     * Prefix sum kernel for block sums.
     *
     * @type {PrefixSumKernel|null}
     */
    _prefixSumKernel: PrefixSumKernel | null;
    /**
     * Dispatch dimensions.
     *
     * @type {{x: number, y: number}}
     */
    _dispatchSize: {
        x: number;
        y: number;
    };
    /**
     * Cached bind group format for block sum shader.
     *
     * @type {BindGroupFormat|null}
     */
    _blockSumBindGroupFormat: BindGroupFormat | null;
    /**
     * Cached bind group format for reorder shader.
     *
     * @type {BindGroupFormat|null}
     */
    _reorderBindGroupFormat: BindGroupFormat | null;
    /**
     * Uniform buffer format for runtime uniforms.
     *
     * @type {UniformBufferFormat|null}
     */
    _uniformBufferFormat: UniformBufferFormat | null;
    /**
     * Cached compute passes. Each entry contains {blockSumCompute, reorderCompute} for one pass.
     *
     * @type {Array<{blockSumCompute: Compute, reorderCompute: Compute}>}
     */
    _passes: Array<{
        blockSumCompute: Compute;
        reorderCompute: Compute;
    }>;
    /**
     * Destroys the ComputeRadixSort instance and releases all resources.
     */
    destroy(): void;
    /**
     * Destroys all cached passes and their shaders.
     *
     * @private
     */
    private _destroyPasses;
    /**
     * Destroys internal buffers (not passes or bind group formats).
     *
     * @private
     */
    private _destroyBuffers;
    /**
     * Gets the sorted indices buffer.
     *
     * @type {StorageBuffer|null}
     */
    get sortedIndices(): StorageBuffer | null;
    /**
     * Creates bind group formats (called once in constructor).
     *
     * @private
     */
    private _createBindGroupFormats;
    /**
     * Creates cached compute passes for all bit offsets.
     *
     * @param {number} numBits - Number of bits to sort.
     * @private
     */
    private _createPasses;
    /**
     * Allocates or resizes internal buffers and creates passes if needed.
     *
     * @param {number} elementCount - Number of elements to sort.
     * @param {number} numBits - Number of bits to sort.
     * @private
     */
    private _allocateBuffers;
    /**
     * Find optimal dispatch dimensions.
     *
     * @param {number} workgroupCount - Total workgroups needed.
     * @returns {{x: number, y: number}} Dispatch dimensions.
     * @private
     */
    private _findOptimalDispatchSize;
    /**
     * Creates a shader with constants embedded.
     *
     * @param {string} name - Shader name.
     * @param {string} source - Shader source.
     * @param {string} entryPoint - Entry point function.
     * @param {number} currentBit - Current bit offset for this pass.
     * @param {boolean} isFirstPass - Whether this is the first pass (uses GID for indices).
     * @param {BindGroupFormat} bindGroupFormat - Bind group format.
     * @returns {Shader} The created shader.
     * @private
     */
    private _createShader;
    /**
     * Executes the GPU radix sort.
     *
     * @param {StorageBuffer} keysBuffer - Input storage buffer containing u32 keys.
     * @param {number} elementCount - Number of elements to sort.
     * @param {number} [numBits] - Number of bits to sort (must be multiple of 4). Defaults to 16.
     * @returns {StorageBuffer} Storage buffer containing sorted indices.
     */
    sort(keysBuffer: StorageBuffer, elementCount: number, numBits?: number): StorageBuffer;
}
import type { GraphicsDevice } from '../../platform/graphics/graphics-device.js';
import { StorageBuffer } from '../../platform/graphics/storage-buffer.js';
import { PrefixSumKernel } from './prefix-sum-kernel.js';
import { BindGroupFormat } from '../../platform/graphics/bind-group-format.js';
import { UniformBufferFormat } from '../../platform/graphics/uniform-buffer-format.js';
import { Compute } from '../../platform/graphics/compute.js';
